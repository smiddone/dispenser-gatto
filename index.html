<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>Dispenser Gatto V16</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg: #f4f8fb; 
            --card: #ffffff;
            --primary: #74b9ff; 
            --primary-dark: #0984e3;
            --success: #00b894;
            --success-light: #55efc4;
            --danger: #ff7675; 
            --warning: #ffeaa7; 
            --text: #2d3436;
            --text-light: #b2bec3;
            --purple: #a29bfe; 
            --purple-dark: #6c5ce7; /* Viola per i bottoni */
        }

        body { font-family: 'Quicksand', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        .container { max-width: 500px; margin: 0 auto; background: var(--card); border-radius: 25px; padding: 25px; box-shadow: 0 15px 35px rgba(116, 185, 255, 0.1); }
        
        h2 { border-bottom: 2px dashed #f1f2f6; padding-bottom: 10px; color: var(--text-light); font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1px; margin-top: 35px; text-align: center; font-family: 'Fredoka', sans-serif;}
        
        /* HEADER CONNESSIONE */
        .conn-wrapper { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; background: #fff; border: 1px solid #eee; padding: 6px 15px; border-radius: 50px; width: fit-content; margin-left: auto; margin-right: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .conn-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; transition: background 0.3s; }
        .conn-text { font-size: 0.8rem; font-weight: bold; color: var(--text-light); }
        
        /* STATUS BADGE */
        .status-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: #fff; border: 2px solid #f1f2f6; padding: 12px 15px; border-radius: 18px; gap: 10px; }
        .status-title { font-family: 'Fredoka', sans-serif; font-weight: 600; font-size: 1.2rem; color: var(--text); line-height: 1.2; }
        
        .mode-badge { 
            padding: 8px 12px; 
            border-radius: 12px; 
            font-weight: 700; 
            font-size: 0.85rem; 
            text-transform: uppercase; 
            text-align: center; 
            min-width: 90px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .mode-active { background: var(--success); color: #fff; }
        .mode-inactive { background: var(--danger); color: #fff; }
        .mode-wait { background: var(--warning); color: #635e4e; }

        /* PROGRESS BAR - VERDE DEFAULT */
        .progress-container { background: #f1f2f6; border-radius: 15px; height: 32px; margin: 15px 0; overflow: hidden; position: relative; border: 1px solid #eee; }
        .progress-bar { 
            height: 100%; 
            background: linear-gradient(90deg, var(--success-light), var(--success)); /* VERDE */
            width: 0%; 
            transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); 
            display: flex; align-items: center; justify-content: center; 
            color: white; font-weight: bold; text-shadow: 0 1px 1px rgba(0,0,0,0.1); font-size: 0.85rem;
        }
        /* Overfeeding VIOLA */
        .progress-over { background: linear-gradient(90deg, var(--purple), var(--purple-dark)) !important; } 
        
        .reset-link { font-size: 0.8rem; color: var(--text-light); text-decoration: none; cursor: pointer; float: right; padding: 5px 10px; border-radius: 5px; transition: color 0.2s; }
        .reset-link:hover { color: var(--danger); }

        /* TABS */
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px; border: 2px solid transparent; background: #f4f8fb; cursor: pointer; border-radius: 12px; font-size: 0.9rem; font-weight: bold; color: var(--text-light); transition: all 0.2s; text-align: center;}
        .tab-btn.active { background: #fff; border-color: var(--primary); color: var(--primary); box-shadow: 0 4px 15px rgba(116, 185, 255, 0.15); }

        .date-panel { background: #fdfdfd; padding: 20px; border-radius: 18px; border: 2px solid #f0f4f8; display: none; margin-bottom: 10px;}
        .date-panel.show { display: block; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .date-label { display: block; font-weight: bold; color: var(--primary-dark); margin-bottom: 12px; font-size: 0.9rem; }

        /* MANUAL BOX */
        .manual-box { background: #eef6ff; padding: 20px; border-radius: 20px; text-align: center; border: 2px solid #e1ecf9; }
        input[type=range] { width: 100%; margin: 20px 0; accent-color: var(--primary); cursor: pointer; height: 6px; background: #dfe6e9; border-radius: 5px; }
        .range-values { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-light); font-weight: bold; margin-bottom: 10px; }
        
        /* ORARI INPUTS - GRID PERFETTA */
        .time-inputs-container { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr; /* 3 colonne uguali */
            gap: 10px; 
            margin-bottom: 15px; 
        }
        input[type="time"], input[type="date"] { 
            padding: 10px; border: 2px solid #f1f2f6; border-radius: 12px; 
            font-family: 'Quicksand', sans-serif; font-weight: bold; color: var(--text); 
            background: #fff; width: 100%; box-sizing: border-box; transition: all 0.3s; outline: none;
            text-align: center; font-size: 1rem;
        }
        input[type="time"]:focus, input[type="date"]:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(116, 185, 255, 0.2); }

        /* BUTTONS */
        button { border: none; border-radius: 12px; font-weight: bold; cursor: pointer; padding: 14px; transition: transform 0.1s, box-shadow 0.2s; font-family: 'Fredoka', sans-serif; letter-spacing: 0.5px;}
        button:active { transform: scale(0.96); }
        
        .btn-main { background: var(--primary); color: white; width: 100%; font-size: 1.1rem; box-shadow: 0 5px 15px rgba(116, 185, 255, 0.4); margin-top: 10px; }
        .btn-main:disabled { background: #cbd5e0; box-shadow: none; cursor: not-allowed; color: #fff; }
        
        .btn-reset { background: transparent; color: var(--danger); border: 2px solid var(--danger-dark); margin-top: 10px; width: 100%; opacity: 0.8; }
        .btn-reset:hover { opacity: 1; background: #fff0f0; }

        /* TASTI VIOLA (SCURI E BEN VISIBILI) */
        .btn-purple { 
            background: var(--purple-dark); /* Viola Scuro */
            color: #ffffff; /* Testo Bianco */
            width: 100%; margin-top: 10px; 
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3); 
        }
        .btn-purple:hover { background: #5f27cd; }

        .input-box { background: #fff; border: 2px solid #f4f8fb; padding: 20px; border-radius: 20px; margin-top: 10px;}
        
        /* ERRORI */
        .error-text { color: var(--danger); font-weight: bold; font-size: 0.9rem; margin-top: 10px; display: none; text-align: center; background: #fff5f5; padding: 10px; border-radius: 8px; border: 1px solid #ffcccc; }
        .error-border input { border-color: var(--danger); }

        .debug-container { background: #fff5f5; padding: 15px; border-radius: 15px; margin-top: 30px; border: 2px dashed #ffdcdc; display: flex; gap: 10px; align-items: center;}
        .log { background: #2d3436; padding: 15px; font-family: monospace; font-size: 0.75rem; color: #55efc4; height: 80px; overflow-y: auto; border-radius: 12px; margin-top: 25px; border: 2px solid #2d3436;}

        /* MEDIA QUERY PER MOBILE */
        @media (max-width: 480px) {
            .btn-reset { font-size: 0.8rem; white-space: normal; padding: 10px; height: auto; }
            .mode-badge { font-size: 0.75rem; min-width: auto; padding: 6px 10px; }
            .status-title { font-size: 1rem; }
            .container { padding: 15px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="conn-wrapper">
        <span id="conn-dot" class="conn-dot" style="background: #b2bec3;"></span>
        <span id="conn-text" class="conn-text">Connessione...</span>
    </div>

    <div>
        <div style="display: flex; justify-content: space-between; align-items: baseline;">
            <span style="font-weight: bold; color: var(--text-light); font-size: 0.9rem;">Mangiato Oggi</span>
            <span class="reset-link" onclick="resetStats()">‚Ü∫ Azzera</span>
        </div>
        <div class="progress-container"><div id="food-bar" class="progress-bar">0%</div></div>
    </div>

    <div style="margin-top: 30px;">
        <div class="status-header">
            <div style="display: flex; flex-direction: column;">
                <span style="font-size: 0.75rem; color: var(--text-light); text-transform: uppercase; font-weight: bold;">Stato Sistema</span>
                <span class="status-title">Automazione</span>
            </div>
            <span id="status-badge" class="mode-badge mode-wait">--</span>
        </div>

        <div class="tabs">
            <div class="tab-btn active" onclick="switchTab('single')" id="tab-single">‚è≥ Scadenza</div>
            <div class="tab-btn" onclick="switchTab('vacation')" id="tab-vacation">üå¥ Vacanza</div>
        </div>

        <div id="panel-single" class="date-panel show">
            <label class="date-label">Esegui automaticamente fino al:</label>
            <input type="date" id="date-stop">
            <!-- Tasto VIOLA -->
            <button class="btn-purple" onclick="setStopDate()">Imposta Data Stop</button>
            <button class="btn-reset" onclick="resetDates()">Cancella (Sempre ON)</button>
        </div>

        <div id="panel-vacation" class="date-panel">
            <label class="date-label">Attiva SOLO in questo periodo:</label>
            <div style="display:flex; gap:10px; margin-bottom: 10px;">
                <div style="flex:1"><span style="font-size:0.7rem; color:var(--text-light); display:block; margin-bottom:5px; font-weight:bold;">DAL</span><input type="date" id="vac-start"></div>
                <div style="flex:1"><span style="font-size:0.7rem; color:var(--text-light); display:block; margin-bottom:5px; font-weight:bold;">AL</span><input type="date" id="vac-end"></div>
            </div>
            <!-- Tasto VIOLA -->
            <button class="btn-purple" onclick="setVacation()">Salva Vacanza</button>
            <button class="btn-reset" onclick="resetDates()">Cancella Date</button>
        </div>
    </div>

    <h2>Manuale</h2>
    <div class="manual-box">
        <span id="slider-desc" style="font-weight: 800; color: var(--primary-dark); font-size: 1.2rem; display: block; font-family: 'Fredoka', sans-serif;">1/3 di Razione (33%)</span>
        <input type="range" id="manual-slider" min="1" max="3" value="1" oninput="updateLabel()">
        <div class="range-values"><span>1/3 (33%)</span><span>1/2 (50%)</span><span>1/1 (100%)</span></div>
        <button id="btn-eroga" class="btn-main" onclick="erogaManuale()" disabled>üçñ EROGA SUBITO</button>
    </div>

    <div class="input-box" id="orari-container">
        <div style="margin-bottom: 20px; font-weight: bold; color: var(--text-light); text-align: center; font-size: 1rem;">‚è∞ Orari Giornalieri</div>
        
        <!-- Grid 3 colonne -->
        <div class="time-inputs-container">
            <input type="time" id="t1"> <input type="time" id="t2"> <input type="time" id="t3">
        </div>
        
        <div id="error-msg" class="error-text"></div>

        <!-- Tasto VIOLA -->
        <button class="btn-purple" onclick="salvaOrari()">Salva Configurazione Orari</button>
    </div>

    <div class="debug-container">
        <span style="font-weight: bold; color: var(--danger);">üîß Debug</span>
        <input type="number" id="debug-steps" placeholder="Passi" style="width: 80px; padding: 10px; border:1px solid #ffcccc; border-radius:8px;">
        <button style="background: var(--danger); color: white; flex: 1; padding: 10px;" onclick="sendCmd('DEBUG:'+document.getElementById('debug-steps').value)">Muovi</button>
    </div>

    <div class="log" id="console">Log sistema...</div>
</div>

<script>
    const mqttHost = "4c412304f01a4a51a191fe4c3d31daa9.s1.eu.hivemq.cloud"; 
    const mqttPort = 8884;
    const mqttUser = "Nicola";
    const mqttPass = "k2gyf!_X95b9dUt";
    
    const topics = {
        cmd: "dispenser/comando",
        orari: "dispenser/set/orari",
        config: "dispenser/set/config",
        dati: "dispenser/dati"
    };

    const client = new Paho.MQTT.Client(mqttHost, Number(mqttPort), "Web-" + Date.now());
    client.onConnectionLost = (r) => { updateStatus(false); log("Persa"); };
    client.onMessageArrived = onMessage;

    client.connect({
        useSSL: true, userName: mqttUser, password: mqttPass,
        onSuccess: () => { 
            updateStatus(true); 
            client.subscribe(topics.dati); 
            log("Connesso - Richiedo dati..."); 
            sendCmd("SYNC");
        },
        onFailure: () => updateStatus(false)
    });

    function onMessage(msg) {
        try {
            const d = JSON.parse(msg.payloadString);
            
            // Barra
            const p = d.percentualeOggi;
            const bar = document.getElementById("food-bar");
            bar.style.width = (p > 100 ? 100 : p) + "%";
            bar.innerText = p + "%";
            
            // Verde se <=100, Viola se >100
            if(p > 100) {
                bar.classList.add("progress-over"); 
            } else {
                bar.classList.remove("progress-over");
            }
            
            const badge = document.getElementById("status-badge");
            badge.innerText = d.activeStatus;
            badge.className = "mode-badge"; 
            if (d.activeStatus.includes("ATTIVO")) badge.classList.add("mode-active");
            else if (d.activeStatus.includes("ATTESA")) badge.classList.add("mode-wait");
            else badge.classList.add("mode-inactive");

            if(document.activeElement.tagName !== "INPUT") {
                document.getElementById("t1").value = d.orario1;
                document.getElementById("t2").value = d.orario2;
                document.getElementById("t3").value = d.orario3;
            }
            if (d.stopTs > 0) document.getElementById("date-stop").value = new Date(d.stopTs * 1000).toISOString().split('T')[0];
            if (d.vacStart > 0) {
                 document.getElementById("vac-start").value = new Date(d.vacStart * 1000).toISOString().split('T')[0];
                 document.getElementById("vac-end").value = new Date(d.vacEnd * 1000).toISOString().split('T')[0];
            }
        } catch(e) {}
    }

    function setStopDate() {
        const val = document.getElementById("date-stop").value;
        if(!val) return alert("Scegli una data");
        const ts = Math.floor(new Date(val).setHours(23,59,59,0) / 1000);
        send(topics.config, "STOP:" + ts);
    }
    function setVacation() {
        const v1 = document.getElementById("vac-start").value;
        const v2 = document.getElementById("vac-end").value;
        if(!v1 || !v2) return alert("Scegli date");
        const ts1 = Math.floor(new Date(v1).setHours(0,0,0,0) / 1000);
        const ts2 = Math.floor(new Date(v2).setHours(23,59,59,0) / 1000);
        if(ts2 < ts1) return alert("Errore date");
        send(topics.config, "VAC:" + ts1 + "," + ts2);
    }
    function resetDates() {
        if(confirm("Cancella date?")) {
            send(topics.config, "RESET_DATES");
            document.getElementById("date-stop").value = "";
            document.getElementById("vac-start").value = "";
            document.getElementById("vac-end").value = "";
        }
    }
    function switchTab(tab) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.date-panel').forEach(p => p.classList.remove('show'));
        document.getElementById('tab-' + tab).classList.add('active');
        document.getElementById('panel-' + tab).classList.add('show');
    }
    function resetStats() { if(confirm("Azzera?")) sendCmd("RESET_STATS"); }
    function sendCmd(c) { send(topics.cmd, c); }
    
    function updateLabel() {
        const v = parseInt(document.getElementById("manual-slider").value);
        const l = document.getElementById("slider-desc");
        if(v===1) l.innerText="1/3 di Razione (33%)"; else if(v===2) l.innerText="1/2 di Razione (50%)"; else l.innerText="Razione Intera (100%)";
    }
    function erogaManuale() {
        const divisore = 4 - parseInt(document.getElementById("manual-slider").value);
        sendCmd("EROGA:" + divisore);
    }

    // --- SALVATAGGIO ORARI CON CONTROLLO CRONOLOGICO ---
    function salvaOrari() {
        const t1 = document.getElementById("t1").value;
        const t2 = document.getElementById("t2").value;
        const t3 = document.getElementById("t3").value;
        const errorDiv = document.getElementById("error-msg");
        const container = document.getElementById("orari-container");

        errorDiv.style.display = "none";
        
        // 1. Almeno uno
        if (!t1 && !t2 && !t3) { showError("‚ö†Ô∏è Inserisci almeno un orario!", errorDiv, container); return; }

        // 2. Controllo Cronologico (Solo se entrambi i campi sono pieni)
        // t1 < t2
        if (t1 && t2 && t1 >= t2) { showError("‚ö†Ô∏è Errore: Orario 1 deve essere prima di Orario 2", errorDiv, container); return; }
        // t2 < t3
        if (t2 && t3 && t2 >= t3) { showError("‚ö†Ô∏è Errore: Orario 2 deve essere prima di Orario 3", errorDiv, container); return; }
        // t1 < t3
        if (t1 && t3 && t1 >= t3) { showError("‚ö†Ô∏è Errore: Orario 1 deve essere prima di Orario 3", errorDiv, container); return; }

        const p1 = t1 || "--:--";
        const p2 = t2 || "--:--";
        const p3 = t3 || "--:--";
        send(topics.orari, `${p1},${p2},${p3}`);
    }

    function showError(msg, div, box) {
        div.innerText = msg;
        div.style.display = "block";
        // Effetto shake
        box.classList.remove("error-border");
        void box.offsetWidth;
        box.classList.add("error-border");
    }

    function send(t, m) { if(client.isConnected()) { const msg = new Paho.MQTT.Message(m); msg.destinationName=t; client.send(msg); } }
    
    function updateStatus(ok) { 
        const dot = document.getElementById("conn-dot");
        const txt = document.getElementById("conn-text");
        const btn = document.getElementById("btn-eroga");
        if(ok) { dot.style.background = "var(--success)"; txt.innerText = "Connesso"; btn.disabled = false; }
        else { dot.style.background = "var(--danger)"; txt.innerText = "Offline"; btn.disabled = true; }
    }
    function log(m) { document.getElementById("console").innerHTML = "> "+m; }
    window.onload = updateLabel;
</script>
</body>
</html>

